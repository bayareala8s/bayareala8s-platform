name: Deploy BayServe v2 PROD

on:
  push:
    branches: [ main ]

env:
  AWS_REGION: us-west-2
  TF_WORKING_DIR: infra/environments/prod
  LAMBDA_BUILD_DIR: products/bayserve-v2/backend
  FRONTEND_DIR: products/bayserve-v2/frontend

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # Backend
      - name: Install backend deps
        working-directory: ${{ env.LAMBDA_BUILD_DIR }}
        run: npm ci

      - name: Build backend
        working-directory: ${{ env.LAMBDA_BUILD_DIR }}
        run: npm run build

      - name: Package Lambda
        working-directory: ${{ env.LAMBDA_BUILD_DIR }}
        run: |
          zip -r bayserve-v2-backend.zip dist node_modules package.json

      # Frontend
      - name: Install frontend deps
        working-directory: ${{ env.FRONTEND_DIR }}
        run: npm ci

      - name: Build frontend
        working-directory: ${{ env.FRONTEND_DIR }}
        env:
          VITE_API_BASE_URL: ${{ secrets.BAYSERVE_PROD_API_BASE }}
          VITE_COGNITO_REGION: ${{ secrets.BAYSERVE_PROD_COGNITO_REGION }}
          VITE_COGNITO_USER_POOL_ID: ${{ secrets.BAYSERVE_PROD_COGNITO_USER_POOL_ID }}
          VITE_COGNITO_CLIENT_ID: ${{ secrets.BAYSERVE_PROD_COGNITO_CLIENT_ID }}
          VITE_COGNITO_DOMAIN: ${{ secrets.BAYSERVE_PROD_COGNITO_DOMAIN }}
          VITE_COGNITO_REDIRECT_URI: ${{ secrets.BAYSERVE_PROD_COGNITO_REDIRECT_URI }}
        run: |
          npm ci
          npm run build


      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.5

      - name: Terraform init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init -input=false

      - name: Terraform apply
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          terraform apply -auto-approve \
            -var "lambda_artifact_path=${{ github.workspace }}/${{ env.LAMBDA_BUILD_DIR }}/bayserve-v2-backend.zip" \
            -var "domain_name=selfserve.bayareala8s.com" \
            -var "certificate_arn=arn:aws:acm:us-east-1:277374794397:certificate/d9b4d687-e6db-4f7b-a0fe-71786fe85b26"

      - name: Upload frontend to S3
        run: |
          aws s3 sync ${{ env.FRONTEND_DIR }}/dist s3://${{ secrets.BAYSERVE_FRONTEND_BUCKET }} --delete

      - name: Invalidate CloudFront Cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.BAYSERVE_CLOUDFRONT_ID }} \
            --paths "/*"
